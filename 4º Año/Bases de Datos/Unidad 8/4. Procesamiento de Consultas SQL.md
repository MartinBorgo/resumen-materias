El procesamiento de consultas hace referencia a una serie de actividades implicadas en la extracción de datos de una base de datos. Estas actividades incluyen la traducción de consultas expresadas en lenguajes de bases de datos de alto nivel en expresiones implementadas en el nivel físico del sistema, así como transformaciones de optimización de consultas y la evaluación real de las mismas. Los pasos involucrados en el procesamiento de consultas involucra el ***análisis y traducción***, la ***optimización*** y finalmente la ***evaluación*** de la consulta.

![[procesamiento-consultas.png]]

La primera acción que el sistema tiene que emprender para procesar una consulta es su traducción a su formato interno. Este proceso de traducción es similar al trabajo que realiza el analizador léxico y semántico de un compilador convencional, construyendo un árbol para el análisis de la consulta, que se transformará posteriormente en una expresión del álgebra relacional.

>[!info] Procesamiento de Vistas
>Si la consulta estuviera expresada en términos de una vista, la fase de traducción también sustituye todas las referencias a vistas por las expresiones del álgebra relacional que las definen.

Dada una consulta hay generalmente distintos métodos para obtener la respuesta. Por ejemplo, ya se ha visto que en SQL se puede expresar una consulta de diferentes maneras. Cada consulta SQL puede traducirse a diferentes expresiones del álgebra relacional. Además de esto, la representación de una consulta en el álgebra relacional especifica de manera parcial cómo evaluar la consulta.
Para especificar completamente cómo evaluar una consulta, no basta con proporcionar la expresión del álgebra relacional, además hay que anotar en ella las instrucciones que especifiquen cómo evaluar cada operación, este nuevo parámetro podría servir para establecer las prioridades en las consultas.
Las operaciones del álgebra relacional anotadas con instrucciones sobre su evaluación reciben el nombre de ***primitivas de evaluación***. El ***motor de ejecución de consultas*** utilizan secuencias de operaciones primitivas para escoger y establecer un ***plan de ejecución de la consulta*** o ***plan de evaluación de la consulta***, para posteriormente ejecutarlo y devolver su respuesta a la consulta.
Los diferentes planes de evaluación de una misma consulta dada pueden tener costes distintos. No se puede esperar que los usuarios escriban las consultas de manera que sugieran el plan de evaluación más eficiente. En su lugar, es responsabilidad del sistema construir un plan de evaluación que minimice el coste de la evaluación de la consulta; esta tarea se denomina ***optimización de consultas***.

## Medidas del Coste de una Consulta

Para optimizar una consulta apropiadamente, el optimizador debe conocer el coste de cada operación. Aunque el coste exacto es difícil de calcular, dado que depende de los siguientes parámetros:

- **Costo de acceso al almacenamiento secundario**: Tiempo de acceso a los registros de un archivo, este tiempo va a depender en parte del tipo de estructuras de acceso a dicho fichero.
- **Costo de almacenamiento**: Cantidad ficheros intermedios generados por la estrategia de ejecución de la consulta.
- **Costo computacional**: Tiempo de ejecución de operaciones sobre los buffers de datos durante la ejecución de la consulta.
- **Costo de uso de memoria**: Cantidad de memoria que se necesitan durante la ejecución de la consulta.
- **Costo de comunicaciones**: Tiempo de envío de la consulta y de sus resultados desde el sitio donde se ubica la base de datos hasta el terminal donde se originó la consulta.

En base a esto parámetros es posible obtener una estimación aproximada del coste de ejecución para cada operación. En grandes sistemas de bases de datos, el coste de acceso a los datos en disco es normalmente el más importante, ya que los accesos a disco son más lentos comparados con las operaciones en memoria.
Para realizar diferentes estrategias de ejecución de consultas, es fundamental considerar la información necesaria en las funciones de costo. Esta información se almacena en el catálogo del sistema de gestión de bases de datos, y es accedida por el optimizador de consultas. El optimizador utiliza los siguientes datos para determinar la forma más eficiente de ejecutar una consulta:

1. **El número de registros (r)**: Representa la cantidad total de registros que hay en un fichero o tabla de la base de datos.
2. **El tamaño medio de los registros (R)**: Indica el tamaño promedio de un registro. Este valor es importante para calcular el espacio que ocupan los datos en almacenamiento.
3. **El número de bloques (b)**: Refleja la cantidad de bloques de almacenamiento que contiene la tabla o una aproximación de este mismo.
4. **El factor de bloqueo (bfr)**: Es el número de registros que caben en un bloque. Este factor ayuda a entender la distribución de datos en los bloques.
5. **Índices secundarios y los atributos de indexación**: Permiten acceder a los registros de manera más rápida sin afectar el orden físico de los datos en el disco. Mientras que los atributos de indexación son las columnas que se utilizan para construir estos índices.
6. **Número de niveles de cada índice multinivel (x)**: Indica la cantidad de niveles que existen en un índice multinivel.
7. **Número de bloques de índices de primer nivel**: Representa la cantidad de bloques que conforman el primer nivel de un índice. Esto es importante para calcular el número de accesos a bloques necesarios durante una operación de búsqueda.

>[!tldr] Selectividad
>La selectividad es un concepto crucial en el procesamiento de consultas porque ayuda a determinar cuántos registros cumplirán con una condición específica. 
>En este contexto el ***número de valores distintos (d)*** es la cantidad de valores únicos que puede tener un atributo en una tabla de la base de datos. Por ejemplo, si una columna tiene el atributo "ciudad" y en la base de datos hay 10 ciudades diferentes, entonces d=10. Mientras que la ***selectividad*** es la proporción de registros que cumplen una condición de igualdad sobre un atributo. Es una medida de cómo se distribuyen los valores en una columna en relación con una condición específica. Por otro lado, la ***cardinalidad de selección (s)*** de un atributo es el número medio de registros que cumplirán una condición de igualdad sobre ese atributo y se calcula de la siguiente manera:
>$$s = sl \times r$$
>En donde $sl$ es la selectividad y $r$ es la cantidad de registros de una tabla. En base a esto podemos llegar a las siguientes conclusiones:
>- Si el atributo es una clave, es decir, cada valor es único, entonces $d = r$ y $sl = 1/r$, por lo tanto $s = 1$.
>- Si el atributo no es clave y los $d$ valores están distribuidos uniformemente $sl = 1 / d$ y por lo tanto $s = r/d$.

