Si $T_i$ necesita bloquear todos los registros de la base de datos, utilizar un protocolo de bloqueo consumiría mucho tiempo, convendría que $T_i$ utilice un solo bloqueo para toda la base de datos. Si $T_i$ necesita sólo unos cuantos registros y se bloquea toda la base de datos, se perdería mucha concurrencia, lo que se necesita es un mecanismo que le permita definir al sistema múltiples niveles de granularidad. Para esto, se debe definir una jerarquía de granularidades de los datos, como se ve en la imagen.

![[granularidad-multinivil.png]]

Cuando una transacción bloquea un nodo ya sea en modo **S** o **X**, esto implica que la transacción bloquea también a todos sus descendientes en el mismo modo.
Supongamos que una transacción $T_i$ bloque el nodo $F_a$ en modo compartido, implícitamente está bloqueando todos sus descendientes del mismo modo. Si la transacción $T_j$ desea bloquear alguna tupla hija de $F_a$ en modo exclusivo, se generará un conflicto.
Para determinar si un nodo puede ser bloqueado o no $T_j$ debe recorrer el camino desde la raíz del árbol hasta el registro que desea bloquear. Si cualquier nodo en el camino está bloqueado en modo incompatible, entonces $T_j$ debe esperar. Supongamos que $T_k$ desea bloquear toda la base de datos, para hacerlo debe bloquear solamente la raíz del árbol, sin embargo $T_k$ no tendría éxito porque $T_i$ tiene actualmente bloqueado $F_a$. Una forma más eficiente de saber si se puede bloquear un nodo de niveles superiores es a través de un nuevo modo de bloqueo denominado ***modo de bloqueo intencional***. 
Si un nodo se bloquea en modo intencional se está haciendo un bloqueo explícito en un nivel inferior del árbol. Los bloqueos intencionales se colocan en todos los ascendientes de un nodo antes de bloquearlo explícitamente, de este modo no es necesario que una transacción busque en todo el árbol para determinar si puede bloquear un nodo con éxito. Una transacción que quiera bloquear $Q$ debe recorrer el camino en el árbol desde la raíz hasta $Q$. Durante el recorrido del árbol la transacción bloquea los distintos nodos en un modo intencional.

>[!tldr] Modos de Intensión Asociados a Estados de Bloqueo
> Hay un modo intencional asociado al modo compartido y hay otro asociado al modo exclusivo, además de un modo de bloqueo adicional de este modo.
> - **Modo Intencional-Compartido (IS)**: Se realiza un bloqueo explícito en un nivel inferior del árbol, pero sólo con bloqueos en modo compartido.
> - **Modo Intencional-Exclusivo (IX)**: Se realiza un bloqueo explícito en un nivel inferior con bloqueos en modo exclusivo o en modo compartido.
> - **Modo Intencional-Exclusivo y Compartido(SIX)**: Se realiza un bloqueo en modo exclusivo del subárbol cuya raíz sea el nodo especificado, y dicho bloqueo explícito se produce en un nivel inferior con bloqueos en modo exclusivo.

## Granularidad Múltiple

El ***protocolo de bloqueo de granularidad múltiple*** siguiente asegura la secuencialidad. En este protocolo cada transacción $T_i$ puede bloquear un nodo $Q$ usando las reglas siguientes:

1. Debe respetarse la función de compatibilidad de bloqueos especificada en la siguiente tabla.

|     | IS        | IX        | S         | SIX       | X         |
|-----|-----------|-----------|-----------|-----------|-----------|
| IS  | Verdadero | Verdadero | Verdadero | Verdadero | Falso     |
| IX  | Verdadero | Verdadero | Falso     | Falso     | Falso     |
| S   | Verdadero | Falso     | Verdadero | Falso     | Falso     |
| SIX | Verdadero | Falso     | Falso     | Falso     | Falso     |
| X   | Falso     | Falso     | Falso     | Falso     | Falso     |

2. Debe bloquear la raíz del árbol en primer lugar y puede bloquearla en cualquier modo.
3. Puede bloquear un nodo $Q$ en modo **C** o **IC** sólo si está bloqueando actualmente al padre de $Q$ en modo **IX** o **IC**.
4. Puede bloquear un nodo $Q$ en modo **X**, **IXC** o **IX** sólo si está bloqueando actualmente al padre de $Q$ en modo **IX** o **IXC**.
5. Puede bloquear un nodo sólo si no ha desbloqueado previamente ningún nodo, es decir, $T_i$ es de dos fases.
6. Puede desbloquear un nodo $Q$ sólo si no ha bloqueado a ninguno de los hijos de $Q$.

Obsérvese que en el protocolo de granularidad múltiple es necesario que se adquieran los bloqueos en *orden descendente*, y que se liberen en *orden ascendente*. Este protocolo permite la concurrencia y reduce la sobrecarga de bloqueos. Es particularmente útil en las aplicaciones con una mezcla de transacciones cortas que sólo acceden a algunos elementos de datos y transacciones largas que producen informes a partir de un archivo completo o un conjunto de archivos.

## Niveles de Aislamiento

