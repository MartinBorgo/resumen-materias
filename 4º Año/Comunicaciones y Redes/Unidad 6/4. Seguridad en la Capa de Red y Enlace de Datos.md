## Seguridad en la Capa de Red
El protocolo de seguridad IP, más conocido como IPsec, proporciona seguridad en la capa de red. IPsec brinda seguridad a los paquetes IP intercambiados por cualesquiera dos entidades de la capa de red, incluyendo hosts y routers. Adicionalmente, este protocolo se utiliza para crear ***redes privadas virtuales (VPN)***.
### Redes Privadas Virtuales (VPN)
Es normal que instituciones que posean sedes en múltiples regiones geográficas deseen disponer de su propia red IP para asegurar que el traspaso de datos e información se realiza de forma segura y rápida, no obstante los gastos requeridos para montar una red privada física es extremadamente elevada.
En lugar de implantar y mantener una red privada física, muchas instituciones optaron por la creación, configuración y uso de una VPN sobre la red de internet pública existente. En este tipo de redes cuando dos host desean intercambiar paquetes, el router de pasarela toma el paquete IP del emisor y lo convierte en un paquete IPsec cifrando los datos antes de que este salga a internet.
El encabezado de los paquetes IPsec son idénticos al de un paquete IP, de esta forma aseguramos que la infraestructura existente de internet pueda encontrar el destinatario para dicho paquete. La principal diferencia entre los paquetes IP e IPsec, es que estos últimos en su carga útil se incluye un encabezado IPsec que se utiliza para procesar ese tipo de paquetes. Cuando el paquete IPsec llega a su destino, el sistema operativo del equipo descifra la carga útil y proporciona algunos otros servicios de seguridad, como la verificación de la integridad de los datos, para posteriormente pasar la carga útil descifrada hacia el protocolo de la capa superior.
### IPsec y Protocolos Asociados
IPsec es un protocolo bastante complejo que está definido en más de una docena de documentos RFC. Dos documentos importantes son RFC 4301, que describe la arquitectura global de seguridad IP, y RFC 2411, que proporciona una panorámica de la serie de protocolos IPsec.
En la serie de protocolos IPsec hay dos protocolos principales, el ***protocolo de cabecera de autenticación (AH)*** y el ***protocolo de carga útil de seguridad para encapsulación (ESP)***. Cuando un emisor utiliza IPsec envía los paquetes a un receptor utilizando uno de estos protocolos. El protocolo AH proporciona autenticación del origen e integridad de los datos, pero no proporciona confidencialidad. Mientras que el protocolo ESP proporciona autenticación del origen, integridad de los datos y confidencialidad. Puesto que la confidencialidad a menudo es crítica para las redes VPN y otras aplicaciones IPsec, el protocolo ESP se utiliza mucho más ampliamente que el protocolo AH.
#### Asociaciones de Seguridad
Las conexiones lógicas entre dos host o routers que se van a intercambiar paquetes IPsec son llamadas ***asociaciones de seguridad (SA)***. Este tipo de conexiones lógicas es de tipo *simplex*, esto quiere decir que en caso de que se quiera intercambiar paquetes entre emisor y receptor se tendrán que tener dos conexiones activas.
Ambas partes, tanto emisor como receptor, deberán mantener cierta información de estado acerca de cada SA que tengan abierta en ese momento. Esta información de estado Incluye:
- Un identificador de 32 bits para cada SA, denominado ***índice de parámetro de seguridad (SPI)***.
- La interfaz de origen y destino de la SA.
- El tipo de cifrado que se va a utilizar durante el intercambio de paquetes.
- La clave de cifrado.
- El tipo de comprobación de integridad utilizada durante la conexión.
- La clave de autenticación.

Cada vez que el emisor desee enviar un paquete IPsec, deberá acceder al la información de estado de la SA específica y utilizar estos datos para realizar el cifrado correspondiente. De manera similar el receptor debe acceder a la información de estado del SA para poder autenticar y desencriptar los datos del paquete IPsec.
Cada entidad IPsec (router o host) suele mantener información de estado para muchas asociaciones de seguridad. Cada entidad IPsec almacena la información de estado para todas sus asociaciones de seguridad en su ***base de datos de asociaciones de seguridad (SAD)***, que es una estructura de datos contenida en el kernel del sistema operativo de esa entidad.

>[!tldr] Gestión de Claves IPsec
>Configurar la información de cada SA y almacenarlo en las SAD de forma manual resulta inviable para una red virtual que cuenta con muchas estaciones de trabajo.  IPsec lleva a cabo este tipo de tarea mediante el ***protocolo de Intercambio de claves de Internet (IKE)***, especificado en RFC 4306.
>IKE presenta algunas similitudes con el procedimiento de acuerdo en SSL. IKE obliga que cada entidad IPsec posean un certificado y la clave pública del destinatario. El protocolo IKE exige que las dos entidades intercambien certificados, negocien los algoritmos de autenticación y cifrado e intercambien de modo seguro el material necesario para crear las claves de sesión para las SA de IPsec. A diferencia de SSL, IKE emplea dos fases para llevar a cabo estas tareas:
>
>1. **Fase uno**: En el primer intercambio de mensajes ambas entidades utilizan el algoritmo de Diffie-Hellman para crear una IKE SA bidireccional entre ambas entidades. Durante esta conexión temporal se establece la clave de cifrado y autenticación, al igual que el valor secreto maestro que se utilizará para calcular las claves IPsec de las asociaciones seguridad que se utilizaran en la segunda fase.
>2. **Fase dos**: En esta fase ambos lados de la conexión rebelan sus identidades, firmando sus mensajes. No obstante, la identidad no es rebelada a nadie que esté espiado las comunicaciones, ya que los mensajes se envían a través del IKE SA seguro. También durante esta fase se negocian los algoritmos de cifrado y autenticación que serán empleados por las asociaciones de seguridad IPsec.
>
>Durante la segunda fase, ambas entidades crean una SA en cada dirección, además al final de esta misma fase tanto la clave de sesión y autenticación se habrán establecido en ambos terminales para las dos SA.

#### Formato del Paquete IPsec
IPsec tiene dos formas distintas de paquete, una para el denominado ***modo túnel*** y otra para el denominado ***modo transporte***. El modo túnel, al ser más apropiado para las redes VPN, está más ampliamente implantado que el modo transporte. Por esta razón solo nos centraremos en explicar el formato de paquetes de este modo en particular.
![[ipsec-formato-modo-tunel.png]]

Cuando un emisor desea enviar un paquete seguido a un receptor, primero debe convertir el paquete IP original a un paquete IPsec, este proceso consta de los siguientes pasos:
1. Añade al final del paquete IP original un campo denominado *cola ESP*.
2. Cifra el resultado utilizando el algoritmo y la clave especificados por la SA.
3. Añada al principio de este paquete cifrado un campo denominado *cabecera ESP*, este paquete resultante es conocido como enchilada.
4. Crea un valor MAC de autenticación para toda la enchilada utilizando el algoritmo y la clave especificada en la SA.
5. Añade el valor MAC al final de la enchilada formado así la carga útil.
6. Crea una nueva cabecera IP basándose en los datos de la cabecera IP original, para posteriormente añadir esta misma al principio de la carga útil.

La unica diferencia entre el paquete IP original y el paquete IPsec es que en la cabecera del paquete IPsec el campo de protocolo es cambiado por el número 50, lo que indica que dicho paquete es un paquete IPsec.
El campo de *cola ESP* ayudan al momento de realizar la suma de comprobación, puesto que los cifrados de bloque requieren que el mensaje que haya que cifrar sea un múltiplo entero de la longitud del bloque el campo de *relleno* ayuda a cumplir con este requisito. El campo de *longitud de relleno* nos indica cuanto relleno se añadió al paquete y, por tanto, cuantos bloques deben ser eliminados. Por último, el campo de *siguiente cabecera* indica que tipo de datos están siendo contenidos dentro en la carga útil (UDP o TCP).
Delante de esta unidad cifrada se encuentra la cabecera ESP, que se envía como texto en claro y que consta de dos campos, el SPI y el campo de número de secuencia. El SPI indica a la entidad receptora cuál es la SA a la que pertenece el paquete.

>[!tldr] Bases de Datos de Políticas de Seguridad
>Junto con su SAD, la entidad IPsec también mantiene otra estructura de datos denominada ***base de datos de políticas de seguridad (SPD)***. La SPD indica qué tipos de datagramas, en función de la dirección IP de origen, la dirección IP de destino y el tipo de protocolo, hay que procesar mediante IPsec; y para aquellos que haya que procesar mediante IPsec, qué SA debe emplearse.
>En un cierto sentido, la información del SPD indica “qué” hacer con los datagramas que lleguen, mientras que la información de la SAD indica “cómo” hay que hacerlo. Esta estructura de datos es útil para saber qué paquetes deben ser convertidos a IPsec antes de salir a Internet y cuáles no.

## Seguridad en la Capa de Enlace de Datos
La seguridad es una preocupación de particular importancia en las redes inalámbricas, en las que las ondas de radio que transportan la tramas pueden propagarse bastante más allá de los límites del edificio que alberga a los hosts y a los puntos de acceso inalámbrico.
### Seguridad en Redes Inalámbricas
Los mecanismos de seguridad inicialmente estandarizados en la especificación 802.11, que se conocen colectivamente con el nombre de ***Privacidad equivalente a la del cable (WEP)***. WEP pretendía proporcionar un nivel de seguridad similar al que podemos encontrar en las redes cableadas aunque sus primeras versiones brindaban una protección relativamente fácil de sobrepasar.
El protocolo WEP del estándar IEEE 802.11 proporciona autenticación y cifrado de datos entre un host y un punto de acceso inalámbrico utilizando una técnica basada en una clave simétrica compartida. WEP no especifica ningún algoritmo de gestión de claves, por lo que se presupone que el host y el punto de acceso inalámbrico han acordado de alguna manera qué clave utilizar, empleando para ello algún método fuera de banda. La autenticación se lleva a cabo de la forma siguiente:
1. Un host inalámbrico solicita la autenticación por parte de un punto de acceso.
2. El punto de acceso responde a la solicitud de autenticación con un número distintivo de 128 bytes.
3. El host inalámbrico cifra el número distintivo utilizando la clave simétrica que comparte con el punto de acceso.
4. El punto de acceso descifra el número distintivo cifrado por el host.

Si el número distintivo descifrado se corresponde con el valor del número distintivo originalmente enviado al host, entonces el host quedará autenticado por el punto de acceso.
Poco después de la publicación en 1999 de la norma IEEE 802.11 comenzó el trabajo para desarrollar una versión nueva y mejorada del estándar, el cual posea mecanismos de seguridad más robustos. El nuevo estándar, conocido con el nombre de 802.11i. Mientras que WEP proporcionaba un cifrado relativamente débil, junto con una única forma de llevar a cabo la autenticación y ningún mecanismo de distribución de claves, IEEE 802.11i proporciona formas mucho más fuertes de cifrado, un conjunto ampliable de mecanismos de autenticación y un mecanismo de distribución de claves.
Esta nueva versión separa el servidor de autenticación del punto de acceso, lo que permite que un solo servidor de autenticación preste sus servicios a múltiples puntos de acceso, centralizando las decisiones relacionadas con la autenticación y al acceso dentro de ese único servidor y manteniendo a un nivel bajo el coste y la complejidad de los puntos de acceso. 802.11i opera en cuatro fases:
1. **Descubrimiento**: En la fase de descubrimiento el punto de acceso anuncia su presencia y las formas de autenticación y cifrado que puede proporcionar al nodo de cliente inalámbrico. El cliente solicita entonces las formas específicas de autenticación y cifrado que desea. Por más que ambos extremos estén intercambiando información el cliente sigue sin estar autorizado.
2. **Autenticación mutua y generación de la clave maestra**: La autenticación tiene lugar entre el cliente inalámbrico y el servidor de autenticación. En esta fase, el punto de acceso actúa como repetidor, reenviando los mensajes entre el cliente y el servidor de autenticación. El ***Protocolo ampliable de autenticación (EAP)*** define los formatos de los mensajes utilizados en un modo de interacción simple de tipo solicitud/respuesta entre el cliente y el servidor de autenticación. Los mensajes EAP se encapsulan utilizando EAPoL y se envían a través del enlace inalámbrico, estos mensajes EAP son entonces desencapsulados en el punto de acceso y luego re-encapsulados utilizando el protocolo RADIUS para su transmisión sobre UDP/IP hacia el servidor de autenticación. Si bien la RFC del protocolo EAP no especifica el uso obligatorio de un servidor RADIUS este se estableció como un estándar de facto por los diferentes proveedores de servicios y fabricantes de hardware.

>[!tldr] Selección del Método de Autenticación
>Con EAP el servidor de autenticación puede seleccionar una de varias formas para llevar a cabo la autenticación. Aunque 802.11i no impone un método de autenticación concreto, a menudo se emplea el esquema de autenticación EAP-TLS el cual utiliza técnicas de clave pública.

3. **Generación de la clave maestra de par**: La clave maestra es un secreto compartido que solo conocen el cliente y el servidor de autenticación y que ambos emplean para generar una segunda clave, la *clave maestra de par (PMK)*. El servidor de autenticación envía entonces la PMK al punto de acceso. El cliente y el punto de acceso ahora disponen de una clave compartida y se habrán autenticado mutuamente entre sí. Ya están casi listos para poder comenzar con la operación real.
4. **Generación de la clave temporal**. Con la PMK, el cliente inalámbrico y el punto de acceso pueden ahora generar claves adicionales que se utilizarán para la comunicación. De particular interés es la *clave temporal (TK)* que se utilizará para realizar el cifrado de nivel de enlace de los datos enviados a través del enlace inalámbrico hacia un host remoto arbitrario.

### Cortafuegos
Un ***cortafuegos*** es una combinación de hardware y software que aísla la red interna de la organización de Internet, permitiendo pasar a algunos paquetes y bloqueando a otros. Un cortafuegos permite a un administrador de red controlar el acceso entre el mundo exterior y los recursos dentro de la red administrada, gestionando el flujo de tráfico hacia y desde esos recursos. Un cortafuegos tiene tres objetivos:
- Todo el tráfico desde y hacia el interior de la red, pasa a través del cortafuegos. Aunque las organizaciones de gran tamaño pueden utilizar varios niveles de cortafuegos o cortafuegos distribuidos, colocar un cortafuegos en un único punto de acceso a la red facilita la gestión y el imponer una política de control de acceso.
- Solo se permite el paso del tráfico autorizado de acuerdo con la política de seguridad local. Con todo el tráfico de entrada y de salida de la red institucional pasando a través del cortafuegos, éste puede restringir el acceso al tráfico autorizado.
- El propio cortafuegos es inmune a la penetración. El cortafuegos es un dispositivo conectado a la red. Si no está diseñado o instalado apropiadamente puede verse comprometido, en cuyo caso solamente proporciona una falsa sensación de seguridad.

Los cortafuegos se pueden clasificar en tres categorías: filtros de paquetes tradicionales, filtros con memoria del estado y pasarelas de aplicación.
#### Filtros de Paquetes Tradicionales
Una organización dispone normalmente de un router de pasarela que conecta su red interna con su ISP. Todo el tráfico que sale y entra en la red interna pasa a través de este router y es en este router donde tiene lugar el filtrado de paquetes. Un filtro de paquetes examina cada paquete IP aisladamente, determinando si debe pasar o debe ser eliminado basándose en las reglas especificadas por el administrador. Las decisiones de filtrado normalmente se basan en:
- Las direcciones IP de origen o de destino.
- El tipo de protocolo especificado en el campo de datagrama IP: TCP, UDP, ICMP, OSPF, etc.
- El puerto de destino y de origen TCP o UDP.
- Los bits indicadores TCP: SYN, ACK, etc.
- El tipo de mensaje ICMP.
- Diferentes reglas para los datagramas que salen y entran en la red.
- Diferentes reglas para las distintas interfaces del router.

Un administrador de red configura el cortafuegos basándose en la política de la organización. La política puede tener en cuenta la productividad del usuario y el uso del ancho de banda, así como los problemas de seguridad de una organización. Las reglas de cortafuegos se implementan directamente en los routers mediante listas de control de acceso, teniendo cada interfaz del router su propia lista.
#### Filtros de Paquetes con Memoria de Estado
En un filtro de paquetes tradicional, las decisiones de filtrado se toman para cada paquete de forma aislada. Los filtros con memoria del estado realmente controlan las conexiones TCP y utilizan dicha información para tomar las decisiones de filtrado. 
Los filtros con memoria del estado almacenan la información de todas las conexiones TCP activas en una tabla de conexiones. Esto es posible porque el cortafuegos puede observar el inicio de una nueva conexión observando un acuerdo en tres fases y puede observar el fin de una conexión cuando ve un paquete FIN para la conexión. El cortafuegos también puede suponer que la conexión ha terminado cuando no ha observado ninguna actividad en la misma durante un periodo de tiempo determinado.
#### Pasarela de Aplicación
En los ejemplos anteriores hemos visto que el filtrado en el nivel de paquetes permite a una organización realizar un filtrado basándose en los contenidos de las cabeceras IP y TCP/UDP, incluyendo las direcciones IP, los números de puerto y los bits de reconocimiento. Pero para conseguir seguridad con un nivel de granularidad más fino, los cortafuegos deben combinar los filtros de paquetes con pasarelas de aplicación.
Las pasarelas de aplicación miran más allá de las cabeceras IP/TCP/UDP y toman sus decisiones basándose en los datos de aplicación. Una pasarela de aplicación es un servidor específico de aplicación a través del cual deben pasar todos los datos de aplicación. Pueden ejecutarse varias aplicaciones de pasarela sobre el mismo host, pero cada pasarela es un servidor separado con sus propios procesos.
Las redes internas a menudo disponen de múltiples pasarelas de aplicación, por ejemplo, pasarelas para Telnet, HTTP, FTP y correo electrónico. De hecho, el servidor de correo de una organización y la caché web son pasarelas de aplicación. 
Las pasarelas de aplicación poseen ciertas desventajas. En primer lugar, hace falta una pasarela de aplicación diferente para cada aplicación. En segundo lugar, el rendimiento se verá afectado, dado que todos los datos tendrán que ser reenviados a través de la pasarela. Esto se convierte en un problema cuando hay varios usuarios o aplicaciones utilizando la misma máquina pasarela. Finalmente, el software de cliente debe saber cómo contactar con la pasarela cuando el usuario realiza una solicitud, y debe saber también cómo decir a la pasarela de aplicación con qué servidor externo hay que conectarse.
### Sistemas de Detección de Intrusiones
Para detectar muchos tipos de ataques necesitamos llevar a cabo una inspección profunda de paquetes, es decir, mirar más allá de los campos de cabecera examinando los propios datos de aplicación transportados por los paquetes.
Un dispositivo que genere alertas cuando observe la presencia de tráfico potencialmente malicioso se denomina ***Sistema de Detección de Intrusiones (IDS)***. Mientras que un dispositivo que filtre el tráfico sospechoso se denomina ***Sistema de Prevención de Intrusiones (IPS)***.
Un sistema IDS puede emplearse para detectar una amplia gama de ataques, incluyendo los de mapeado de red, escaneo de puertos, escaneos de la pila TCP, ataques DoS de inundación del ancho de banda, gusanos y virus, ataques de vulnerabilidades del sistema operativo y ataques de vulnerabilidades de aplicación. Una organización puede implantar uno o más sensores IDS en su red. Cuando se implantan múltiples sensores, normalmente funcionan de manera concertada, enviando información acerca de las actividades de tráfico sospechoso a un procesador IDS central que recopila e integra la información y envía alarmas a los administradores de la red cuando lo considera apropiado. Los sistemas IDS se pueden clasificar en términos generales en ***sistemas basados en firma*** o ***sistemas basados en anomalías***.
Un IDS basado en firmas mantiene una amplia base de datos de firmas de ataque. Cada firma es un conjunto de reglas concernientes a una actividad de intrusión. Una firma puede ser simplemente una lista de características acerca de un determinado paquete o puede estar relacionada con una serie de paquetes. El administrador de red de una organización puede personalizar las firmas o añadir otras de su creación a la base de datos.
Los sistemas IDS basados en firma, aunque están ampliamente implantados, presentan una serie de limitaciones. La más importante es que se requiere un conocimiento previo del ataque para generar una firma precisa. En otras palabras, un IDS basado en firmas es completamente inútil frente a nuevos ataques que todavía no hayan sido investigados. Otra desventaja es que incluso si se produce una concordancia con una firma, puede que dicha concordancia no sea el resultado de un ataque, con lo que se generaría una falsa alarma. Finalmente, puesto que es necesario comparar cada paquete con una amplia colección de firmas, el IDS puede verse desbordado por las necesidades de procesamiento y debido a ello fracasar a la hora de detectar muchos paquetes maliciosos.
Un IDS basado en anomalías crea un perfil de tráfico observando el tráfico durante la operación normal. Después busca flujos de paquetes que sean estadísticamente inusuales, como por ejemplo un porcentaje inusual de paquetes ICMP o un crecimiento exponencial súbito en el escaneo de puertos y barridos mediante ping. Lo mejor de los sistemas IDS basados en anomalías es que no dependen del conocimiento previo acerca de los ataques existentes; es decir, pueden detectar potencialmente nuevos ataques no documentados. Por otro lado, el problema de distinguir entre el tráfico normal y el tráfico estadísticamente inusual es extremadamente complejo.