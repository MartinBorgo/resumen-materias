
## Seguridad en la Capa de Red

El protocolo de seguridad IP, más conocido como IPsec, proporciona seguridad en la capa de red. IPsec brinda seguridad a los paquetes IP intercambiados por cualesquiera dos entidades de la capa de red, incluyendo hosts y routers. Adicionalmente, este protocolo se utiliza para crear ***redes privadas virtuales (VPN)***.

### Redes Privadas Virtuales (VPN)

Es normal que instituciones que posean sedes en múltiples regiones geográficas deseen disponer de su propia red IP para asegurar que el traspaso de datos e información se realiza de forma segura y rápida, no obstante los gastos requeridos para montar una red privada física es extremadamente elevada.
En lugar de implantar y mantener una red privada física, muchas instituciones optaron por la creación, configuración y uso de una VPN sobre la red de internet pública existente. En este tipo de redes cuando dos host desean intercambiar paquetes, el router de pasarela toma el paquete IP del emisor y lo convierte en un paquete IPsec cifrando los datos antes de que este salga a internet.
El encabezado de los paquetes IPsec son idénticos al de un paquete IP, de esta forma aseguramos que la infraestructura existente de internet pueda encontrar el destinatario para dicho paquete. La principal diferencia entre los paquetes IP e IPsec, es que estos últimos en su carga útil se incluye un encabezado IPsec que se utiliza para procesar ese tipo de paquetes. Cuando el paquete IPsec llega a su destino, el sistema operativo del equipo descifra la carga útil y proporciona algunos otros servicios de seguridad, como la verificación de la integridad de los datos, para posteriormente pasar la carga útil descifrada hacia el protocolo de la capa superior.



### IPsec y Protocolos Asociados

IPsec es un protocolo bastante complejo que está definido en más de una docena de documentos RFC. Dos documentos importantes son RFC 4301, que describe la arquitectura global de seguridad IP, y RFC 2411, que proporciona una panorámica de la serie de protocolos IPsec.
En la serie de protocolos IPsec hay dos protocolos principales, el ***protocolo de cabecera de autenticación (AH)*** y el ***protocolo de carga útil de seguridad para encapsulación (ESP)***. Cuando un emisor utiliza IPsec envía los paquetes a un receptor utilizando uno de estos protocolos. El protocolo AH proporciona autenticación del origen e integridad de los datos, pero no proporciona confidencialidad. Mientras que el protocolo ESP proporciona autenticación del origen, integridad de los datos y confidencialidad. Puesto que la confidencialidad a menudo es crítica para las redes VPN y otras aplicaciones IPsec, el protocolo ESP se utiliza mucho más ampliamente que el protocolo AH.

#### Asociaciones de Seguridad

Las conexiones lógicas entre dos host o routers que se van a intercambiar paquetes IPsec son llamadas ***asociaciones de seguridad (SA)***. Este tipo de conexiones lógicas es de tipo *simplex*, esto quiere decir que en caso de que se quiera intercambiar paquetes entre emisor y receptor se tendrán que tener dos conexiones activas.
Ambas partes, tanto emisor como receptor, deberán mantener cierta información de estado acerca de cada SA que tengan abierta en ese momento. Esta información de estado Incluye:

- Un identificador de 32 bits para cada SA, denominado ***índice de parámetro de seguridad (SPI)***.
- La interfaz de origen y destino de la SA.
- El tipo de cifrado que se va a utilizar durante el intercambio de paquetes.
- La clave de cifrado.
- El tipo de comprobación de integridad utilizada durante la conexión.
- La clave de autenticación.

Cada vez que el emisor desee enviar un paquete IPsec, deberá acceder al la información de estado de la SA específica y utilizar estos datos para realizar el cifrado correspondiente. De manera similar el receptor debe acceder a la información de estado del SA para poder autenticar y desencriptar los datos del paquete IPsec.
Cada entidad IPsec (router o host) suele mantener información de estado para muchas asociaciones de seguridad. Cada entidad IPsec almacena la información de estado para todas sus asociaciones de seguridad en su ***base de datos de asociaciones de seguridad (SAD)***, que es una estructura de datos contenida en el kernel del sistema operativo de esa entidad.

>[!tldr] Gestión de Claves IPsec
>Configurar la información de cada SA y almacenarlo en las SAD de forma manual resulta inviable para una red virtual que cuenta con muchas estaciones de trabajo.  IPsec lleva a cabo este tipo de tarea mediante el ***protocolo de Intercambio de claves de Internet (IKE)***, especificado en RFC 4306.
>IKE presenta algunas similitudes con el procedimiento de acuerdo en SSL. IKE obliga que cada entidad IPsec posean un certificado y la clave pública del destinatario. El protocolo IKE exige que las dos entidades intercambien certificados, negocien los algoritmos de autenticación y cifrado e intercambien de modo seguro el material necesario para crear las claves de sesión para las SA de IPsec. A diferencia de SSL, IKE emplea dos fases para llevar a cabo estas tareas:
>
>1. **Fase uno**: En el primer intercambio de mensajes ambas entidades utilizan el algoritmo de Diffie-Hellman para crear una IKE SA bidireccional entre ambas entidades. Durante esta conexión temporal se establece la clave de cifrado y autenticación, al igual que el valor secreto maestro que se utilizará para calcular las claves IPsec de las asociaciones seguridad que se utilizaran en la segunda fase.
>2. **Fase dos**: En esta fase ambos lados de la conexión rebelan sus identidades, firmando sus mensajes. No obstante, la identidad no es rebelada a nadie que esté espiado las comunicaciones, ya que los mensajes se envían a través del IKE SA seguro. También durante esta fase se negocian los algoritmos de cifrado y autenticación que serán empleados por las asociaciones de seguridad IPsec.
>
>Durante la segunda fase, ambas entidades crean una SA en cada dirección, además al final de esta misma fase tanto la clave de sesión y autenticación se habrán establecido en ambos terminales para las dos SA.

#### Formato del Paquete IPsec

IPsec tiene dos formas distintas de paquete, una para el denominado ***modo túnel*** y otra para el denominado ***modo transporte***. El modo túnel, al ser más apropiado para las redes VPN, está más ampliamente implantado que el modo transporte. Por esta razón solo nos centraremos en explicar el formato de paquetes de este modo en particular.

![[ipsec-formato-modo-tunel.png]]

Cuando un emisor desea enviar un paquete seguido a un receptor, primero debe convertir el paquete IP original a un paquete IPsec, este proceso consta de los siguientes pasos:

1. Añade al final del paquete IP original un campo denominado *cola ESP*.
2. Cifra el resultado utilizando el algoritmo y la clave especificados por la SA.
3. Añada al principio de este paquete cifrado un campo denominado *cabecera ESP*, este paquete resultante es conocido como enchilada.
4. Crea un valor MAC de autenticación para toda la enchilada utilizando el algoritmo y la clave especificada en la SA.
5. Añade el valor MAC al final de la enchilada formado así la carga útil.
6. Crea una nueva cabecera IP basándose en los datos de la cabecera IP original, para posteriormente añadir esta misma al principio de la carga útil.

La unica diferencia entre el paquete IP original y el paquete IPsec es que en la cabecera del paquete IPsec el campo de protocolo es cambiado por el número 50, lo que indica que dicho paquete es un paquete IPsec.
El campo de *cola ESP* ayudan al momento de realizar la suma de comprobación, puesto que los cifrados de bloque requieren que el mensaje que haya que cifrar sea un múltiplo entero de la longitud del bloque el campo de *relleno* ayuda a cumplir con este requisito. El campo de *longitud de relleno* nos indica cuanto relleno se añadió al paquete y, por tanto, cuantos bloques deben ser eliminados. Por último, el campo de *siguiente cabecera* indica que tipo de datos están siendo contenidos dentro en la carga útil (UDP o TCP).
Delante de esta unidad cifrada se encuentra la cabecera ESP, que se envía como texto en claro y que consta de dos campos, el SPI y el campo de número de secuencia. El SPI indica a la entidad receptora cuál es la SA a la que pertenece el paquete.

>[!tldr] Bases de Datos de Políticas de Seguridad
>Junto con su SAD, la entidad IPsec también mantiene otra estructura de datos denominada ***base de datos de políticas de seguridad (SPD)***. La SPD indica qué tipos de datagramas, en función de la dirección IP de origen, la dirección IP de destino y el tipo de protocolo, hay que procesar mediante IPsec; y para aquellos que haya que procesar mediante IPsec, qué SA debe emplearse.
>En un cierto sentido, la información del SPD indica “qué” hacer con los datagramas que lleguen, mientras que la información de la SAD indica “cómo” hay que hacerlo. Esta estructura de datos es útil para saber qué paquetes deben ser convertidos a IPsec antes de salir a Internet y cuáles no.

