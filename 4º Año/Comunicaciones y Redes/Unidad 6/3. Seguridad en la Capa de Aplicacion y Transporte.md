Las dos secciones anteriores de esta unidad hemos expuesto los diferentes mecanismos que se utilizan para brindar confidencialidad, integridad y autenticación durante el proceso de comunicación ahora veremos como se aplican cada uno de estos conceptos en las diferentes capas del modelo estudiado.

>[!tldr] Seguridad a Nivel de Capa Individual
>Por más que las capas subyacentes de cada nivel implementen distintos mecanismos de seguridad, ninguna de las capas puede confiar en su totalidad en la seguridad brindada por las capas superiores o superiores, esto es así, ya que cada capa y cada protocolo implementa la seguridad de acuerdo a las necesidades y limitaciones del protocolo en cuestión. Además, por lo menos a nivel de la capa de transporte y aplicación, suele ser más sencillo implementar servicios seguros que en el resto de capas.
## Correo Electrónico Seguro y PGP
Al momento de implementar un servicio de seguridad sobre un protocolo o extender uno mismo para brindar una mayor seguridad, en primer lugar se deben analizar que propiedades de seguridad son deseables en dicho protocolo, en caso de los correos electrónicos, características como la confidencialidad, la integridad de los mensajes y la autenticación tanto del receptor como del emisor son primordiales.
***Pretty Good Privacy (PGP)*** es un esquema de cifrado de correo electrónico que se ha convertido en un estándar de facto. Cuando se instala PGP, el software crea una pareja de clave pública y privada para el usuario. La clave pública puede darse a conocer a todo el mundo, mientras que la clave privada está protegida mediante el uso de una contraseña.
PGP le da al usuario la opción de firmar digitalmente el mensaje, de cifrar el mensaje o de realizar tanto la operación de firma como la de cifrado. La información sobre la firma del mensaje aparecerá después de la cabecera MIME del correo. Dicha firma no es más que el resultado de aplicar una función hash sobre el mensaje y luego cifrar dicho resultado con la clave privada del emisor.
Al momento de cifrar los mensajes el emisor cifra los datos utilizando una clave de sesión creada únicamente para ese mensaje, luego cifra dicha clave con la clave pública del receptor, finalmente se unen el mensaje cifrado y la clave de sesión cifrada para ser enviados ambos a destino. Cuando el receptor recibe el mensaje descifra la clave de sesión con su clave privada, una vez obtenida la clave de sesión se desencripta el mensaje cifrado para acceder a al texto plano.
Las claves públicas PGP están certificadas por una red de confianza. Los usuarios pueden certificar cualquier pareja de clave/usuario cuando crea que esa pareja es realmente correcta. Además, PGP permite que los usuarios digan que confía en algún otro usuario a la hora de certificar la autenticidad de otras claves.
## Conexiones TCP Seguras y SSL
Cuando hablamos de la capa de transporte las características más deseables para las comunicaciones son la confidencialidad, la integridad de los datos y la autenticación de los puntos terminales. La versión mejorada de TCP que brinda todas estas características se la conoce como ***Secure Socket Layer (SSL)***. En la actualidad también se utiliza una versión ligeramente modificada de la versión 3 de SSL, a la cual se la denomina ***Trasport Layer Security (TLS)***.
SSL se emplea a menudo para proporcionar seguridad a las transacciones que tienen lugar a través de HTTP. Sin embargo, puesto que SSL dota de seguridad a TCP, puede ser empleado por cualquier aplicación que se ejecute sobre TCP. SSL proporciona una API simple con sockets, que es similar y análoga a la API de TCP. Aunque SSL reside técnicamente en la capa de aplicación, desde la perspectiva del desarrollador se trata de un protocolo de transporte que proporciona servicios TCP mejorados con servicios de seguridad.
### Funcionamiento de la Subcapa SSL
Una conexión que utiliza SSL consta de tres fases, la fase de acuerdo, la fase de deducción de la clave y la fase de transferencia de datos. Para realizar una conexión utilizando SSL el servidor debe tener un par de claves públicas y privada y una certificación que asocie su identidad a dicha clave pública.
- **Fase de acuerdo**: Durante la fase de acuerdo, el cliente y el servidor realizan los siguientes pasos:
	1. El cliente envía un mensaje de solicitud de conexión donde se adjunta una lista de los algoritmos criptográficos que soporta, en conjunto con un número distintivo del cliente.
	2. A partir de dicha lista, el servidor elige el algoritmo un algoritmo simétrico, un algoritmo de clave pública y un algoritmo de MAC, posteriormente envía al cliente las elecciones de algoritmos, junto con su certificado y clave pública.
	3. El cliente verifica el certificado, extrae la clave pública del servidor y genera una clave pre-maestra (PMS), encripta la clave pre-maestra con la clave pública del servidor y se la envía al servidor.
	4. Cliente y servidor utilizando la misma función de deducción, calculan de manera independiente la clave maestra a partir de la PMS y los números distintivos. En caso de que el algoritmo de cifrado simétrico seleccionado utiliza CBC también se obtendrán dos vectores de inicialización, uno para cada lado de la conexión.
	5. El cliente calcula un código MAC a partir de todos los mensajes enviados y recibidos.
	6. El servidor envía un código MAC a partir de todos los mensajes enviados y recibidos.

>[!info] Comprobación de Integridad de la Conexión SSL
>Tanto el quinto como sexto paso cumplen una función clave para prevenir posibles ataques, ya que los atacantes al momento de establecer la conexión pueden eliminar alguno de los algoritmos más fuertes de la lista de algoritmos enviada por el cliente, al hacer que tanto el cliente como el servidor envíen códigos MAC basándose en los mensajes enviados y recibidos nos aseguramos de que la comunicación no haya sido intervenida.

- **Fase de deducción de claves**: En esta fase tanto cliente como servidor generan distintas claves de cifrado que se utilizaran para encriptar los distintos mensajes que se intercambien entre ellos.
- **Fase de transferencia de datos**: En esta etapa se divide el flujo de datos en registros a los cuales se le añade su propio código MAC para la comprobación de integridad del mismo, para luego ser cifrados en conjunto. Para generar los códigos MAC, el emisor introduce los datos del registro, el número de secuencia SSL del registro y una de las claves generadas en la fase anterior.

>[!tldr] Estructura del Registro SSL
>Los registros SSL constan de cuatro campos, un campo de tipo, un campo de versión, un campo de longitud, un campo de datos y un campo MAC, tal y como se muestra en la imagen.
>
>![[registro-ssl.png]]
>
>Observe que los tres primeros campos no están cifrados. El campo de tipo indica si el registro es un mensaje de la fase de acuerdo o un mensaje que contiene datos de aplicación. El registro de tipo también puede ser utilizado para cerrar la conexión SSL tal y como explicaremos más adelante.

A la hora de generar los valores MAC se suele utilizar el número de secuencia del registro SSL porque este nos brinda cierta robustez contra ataques por interposición. De esta forma se impide que los interceptores de la comunicación realicen reordenamientos o reproducciones del segmento.
Una forma de cerrar una conexión SSL entre un cliente y un servidor sería cerrando la conexión TCP subyacente, si bien este es el método más sencillo, este introduce una serie de problemas de seguridad, dado que un atacante podría enviar al servidor un segmento TCP de finalización y cerrar la comunicación entre ambos terminales. La solución a este problema consiste en indicar en el campo de *tipo* del registro si dicho mensaje sirve para terminar con la conexión, de esta forma si el servidor recibe un mensaje de finalización TCP antes del segmento que contenga el registro de finalización el servidor sabrá que alguien está intentando intervenir en la comunicación.
